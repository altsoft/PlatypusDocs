<?xml version='1.0' encoding='utf-8' ?>
<!DOCTYPE appendix PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN" "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd" [
<!ENTITY % BOOK_ENTITIES SYSTEM "Administration_Guide.ent">
%BOOK_ENTITIES;
]>
<appendix id="appe-Administration_Guide-Glassfish_Appendix" lang="ru-RU">
	<title>Настройка J2EE сервера Glassfish 3.1.2</title>
	 <note>
		<para>
			Для получения подробной информации по настройке <application>Glassfish</application> обратитесь к документации данного сервера приложений.
		</para>

	</note>
	 <para>
		Настройка источника данных:
	</para>
	 <orderedlist>
		<listitem>
			<para>
				Скопируйте JAR-файл JDBC драйвера в каталог доступный загрузчику классов: <filename>glassfish/domains/mydomain/lib </filename>
			</para>

		</listitem>
		 <listitem>
			<para>
				Запустите консоль администрирования GlassFish. Для этого запустите сервер, например, используя утилиту asadmin. Далее в браузере перейдите по адресу <filename>http://hostname:4848</filename>, где hostname - адрес сервера приложений Glassfish, например: <filename>http://localhost:4848</filename>.
			</para>

		</listitem>
		 <listitem>
			<para>
				Создайте пул подключений JDBC: <guimenuitem>Resources -&gt; JDBC -&gt; JDBC Connection Pools -&gt; New</guimenuitem>, Тип ресурса <type>javax.sql.ConnectionPoolDataSource</type>, а так же укажите параметры подключения к БД: <parameter>url</parameter>, <parameter>schema</parameter>, <parameter>username</parameter>, <parameter>password</parameter>;
			</para>

		</listitem>
		 <listitem>
			<para>
				Проверьте правильность настройки пула, нажав кнопку Ping;
			</para>

		</listitem>
		 <listitem>
			<para>
				Создайте JNDI ресурс для пула подключений: <guimenuitem>Resources -&gt; JDBC Resources-&gt; New</guimenuitem>; Задайте имя ресурса и укажите пул подключений JDBC.
			</para>

		</listitem>

	</orderedlist>
	 <para>
		Задайте параметры инициализации web-приложения <parameter>url</parameter>, <parameter>dialect</parameter> и <parameter>schema</parameter> в файле web.xml.
	</para>
	 <para>
		Для того, чтобы настроить Platypus для работы с внутренним хранилищем данных о пользователях или внешним сервисом аутентификации:
	</para>
	 <itemizedlist>
		<listitem>
			<para>
				Настройте J2EE сервер Glassfish для работы с областью безопасности (Realm) во внешнем LDAP сервисе;
			</para>

		</listitem>
		 <listitem>
			<para>
				Настройте учетные записи пользователей.
			</para>

		</listitem>

	</itemizedlist>
	 <para>
		Для того, чтобы настроить сервер Glassfish:
	</para>
	 <itemizedlist>
		<listitem>
			<para>
				Добавьте область безопасности для Glassfish - для этого измените конфигурацию сервера Configurations -&gt; server-config -&gt; Security -&gt; Realms -&gt;New;
			</para>
			 <para>
				Задайте имя области безопасности, выберите имя класса из списка или укажите свой класс:
			</para>
			 <itemizedlist>
				<listitem>
					<para>
						Для использования встроенного хранилища Platypus укажите имя класса com.sun.enterprise.security.auth.realm.jdbc.JDBCRealm; Настройте свойства, специфические для этого класса:
					</para>
					 <table>
						<title>Свойства области безопасности JDBCRealm</title>
						 <tgroup cols="2">
							<tbody>
								<row>
									<entry>
										<parameter>JAAS Context</parameter>
									</entry>
									 <entry>
										Идентификатор логин-модуля, JDBCRealm
									</entry>

								</row>
								 <row>
									<entry>
										<parameter>User Table</parameter>
									</entry>
									 <entry>
										Имя таблицы пользователей в БД, MTD_USERS
									</entry>

								</row>
								 <row>
									<entry>
										<parameter>User Name Column</parameter>
									</entry>
									 <entry>
										Имя столбца в таблице пользователей в котором хранятся имена пользователй, USR_NAME
									</entry>

								</row>
								 <row>
									<entry>
										<parameter>Password Column</parameter>
									</entry>
									 <entry>
										Имя столбца в таблице пользователей в котором хранятся хэши паролей, USR_PASSWD
									</entry>

								</row>
								 <row>
									<entry>
										<parameter>Group Table</parameter>
									</entry>
									 <entry>
										Имя таблицы групп пользователей, USR_GROUPS
									</entry>

								</row>
								 <row>
									<entry>
										<parameter>Group Name Column</parameter>
									</entry>
									 <entry>
										Имя столбца имен групп в таблице групп пользователей, GROUP_NAME
									</entry>

								</row>
								 <row>
									<entry>
										<parameter>Digest Algorithm</parameter>
									</entry>
									 <entry>
										Алгоритм хэширования пароля, MD5
									</entry>

								</row>

							</tbody>

						</tgroup>

					</table>

				</listitem>
				 <listitem>
					<para>
						Для использования внешнего сервиса LDAP (Active Directory, OpenLDAP и т.д.) укажите имя класса com.sun.enterprise.security.auth.realm.ldap.LDAPReam; Настройте свойства, специфические для этого класса:
					</para>
					 <table>
						<title>Основные и дополнительные свойства области безопасности LDAPReam</title>
						 <tgroup cols="2">
							<tbody>
								<row>
									<entry>
										<parameter>JAAS Context</parameter>
									</entry>
									 <entry>
										Идентификатор логин-модуля, ldapRealm
									</entry>

								</row>
								 <row>
									<entry>
										<parameter>Directory</parameter>
									</entry>
									 <entry>
										ldap://server:389
									</entry>

								</row>
								 <row>
									<entry>
										<parameter>Base DN</parameter>
									</entry>
									 <entry>
										DC=ithit,DC=com
									</entry>

								</row>
								 <row>
									<entry>
										<parameter>Assign Groups</parameter>
									</entry>
									 <entry>
										platypus_default_role
									</entry>

								</row>
								 <row>
									<entry>
										<parameter>search-filter</parameter>
									</entry>
									 <entry>
										(&amp;(objectClass=user)(sAMAccountName=%s))
									</entry>

								</row>
								 <row>
									<entry>
										<parameter>search-bind-password</parameter>
									</entry>
									 <entry>
										пароль сервиса LDAP
									</entry>

								</row>
								 <row>
									<entry>
										<parameter>group-search-filter</parameter>
									</entry>
									 <entry>
										(&amp;(objectClass=group)(member=%d))
									</entry>

								</row>
								 <row>
									<entry>
										<parameter>search-bind-dn</parameter>
									</entry>
									 <entry>
										ithit\user
									</entry>

								</row>

							</tbody>

						</tgroup>

					</table>
					 <note>
						<para>
							Задайте значения свойств в соответствии с конфигурацией вашего LDAP-сервера. Значение свойства <parameter>Assign Groups</parameter>, группа platypus_default_role будет присвоена всем пользователям.
						</para>

					</note>
					 <para>
						Сконфигурируйте JVM: Configurations -&gt; server-config -&gt; JVM Settings -&gt; Add JVM Option - добавьте следующую опцию: Djava.naming.referral=follow
					</para>

				</listitem>

			</itemizedlist>

		</listitem>
		 <listitem>
			<para>
				Настройте режим аутентификации для web-приложения в котором будет развернут Platypus Servlet: в файле WEB-INF/web.xml для режима аутентификации укажите имя области безопасности (Realm Name), например, ldapRealm, которое было настроено на предыдущем шаге и создайте роли безопасности: добавьте следующий элемент после элемента &lt;security-constraint&gt; в файле web.xml, пример для BASIC аутентификации:
			</para>
			 
<programlisting>&lt;web-app ... &gt; 
   ... 
   &lt;login-config&gt;
        &lt;auth-method&gt;BASIC&lt;/auth-method&gt;
        &lt;realm-name&gt;ldapRealm&lt;/realm-name&gt;
   &lt;/login-config&gt;
   ...
&lt;/web-app&gt;</programlisting>

		</listitem>
		 <listitem>
			<para>
				Добавьте роли безопасности:
			</para>
			 
<programlisting>&lt;web-app ... &gt; 
   ... 
   &lt;security-role&gt;
      &lt;role-name&gt;role1&lt;/role-name&gt;
   &lt;/security-role&gt;
   ...
&lt;/web-app&gt;</programlisting>

		</listitem>
		 <listitem>
			<para>
				Добавьте ограничение безопасности:
			</para>
			 
<programlisting>&lt;web-app ... &gt;
...
&lt;web-resource-collection&gt;
            &lt;web-resource-name&gt;platypus&lt;/web-resource-name&gt;
            &lt;description/&gt;
            &lt;url-pattern&gt;/examples/Maps.jsp&lt;/url-pattern&gt;
            &lt;url-pattern&gt;/application/*&lt;/url-pattern&gt;
        &lt;/web-resource-collection&gt;
        &lt;auth-constraint&gt;
            &lt;description/&gt;
            &lt;role-name&gt;platypus_default_role&lt;/role-name&gt;
            &lt;role-name&gt;role1&lt;/role-name&gt;
            &lt;role-name&gt;role2&lt;/role-name&gt;
            &lt;role-name&gt;role3&lt;/role-name&gt;
        &lt;/auth-constraint&gt;
    &lt;/security-constraint&gt;
...
&lt;/web-app&gt;</programlisting>

		</listitem>
		 <listitem>
			<para>
				В файле <filename>WEB-INF/glassfish-web.xml</filename> свяжите роли с группами LDAP:
			</para>
			 
<programlisting>&lt;glassfish-web-app error-url=""&gt;
...
  &lt;context-root&gt;/platypus&lt;/context-root&gt;
  &lt;security-role-mapping&gt;
    &lt;role-name&gt;platypus_default_role&lt;/role-name&gt;
    &lt;group-name&gt;default&lt;/group-name&gt;
  &lt;/security-role-mapping&gt;
  &lt;security-role-mapping&gt;
    &lt;role-name&gt;role1&lt;/role-name&gt;
    &lt;group-name&gt;role1&lt;/group-name&gt;
  &lt;/security-role-mapping&gt;
  &lt;security-role-mapping&gt;
    &lt;role-name&gt;role2&lt;/role-name&gt;
    &lt;group-name&gt;role2&lt;/group-name&gt;
  &lt;/security-role-mapping&gt;
  &lt;security-role-mapping&gt;
    &lt;role-name&gt;role3&lt;/role-name&gt;
    &lt;group-name&gt;role3&lt;/group-name&gt;
  &lt;/security-role-mapping&gt;
..
&lt;/glassfish-web-app&gt;</programlisting>

		</listitem>

	</itemizedlist>
	 <para>
		В LDAP сервиса создайте соответствующих пользователей, их группы и добавьте пользователей в эти группы.
	</para>
	 <note>
		<para>
			Для получения подробной информации по настройке сервера и клиента LDAP обратитесь к документации <application>OpenLDAP</application> и <application>Microsoft Active Directory</application>.
		</para>

	</note>
</appendix>

