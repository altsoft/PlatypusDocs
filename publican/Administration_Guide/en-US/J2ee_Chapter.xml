<?xml version='1.0' encoding='UTF-8'?>
<!-- This document was created with Syntext Serna Free. --><!DOCTYPE chapter PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN" "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd" [
<!ENTITY % BOOK_ENTITIES SYSTEM "Administration_Guide.ent">
%BOOK_ENTITIES;
]>
<chapter id="chap-Administration_Guide-J2ee_Chapter">
  <title>Java EE server</title>
  <para>The plaftorm&apos;s server components can run in a J2EE server or a servlet container. </para>
  <para>This configuration has the following features:</para>
  <itemizedlist>
    <listitem>
      <para>Server components are deployed in the J2EE  container/on the server as a web-application as a WAR-archive or  a folder. Special sevlet provides interaction with the clients.</para>
    </listitem>
    <listitem>
      <para>Desktop client and HTML5 browser are supported as clients.</para>
    </listitem>
    <listitem>
      <para>It is possible to use an external user authentication service, such as  <application>Microsoft Active Directory</application> service; it allows you to integrate the  platform target application in existing enterprise user space.</para>
    </listitem>
    <listitem>
      <para>Database connecions are configrued as a  JNDI resources. </para>
    </listitem>
    <listitem>
      <para>Application sever modules methods are avaliable via HTTP protocol. </para>
    </listitem>
  </itemizedlist>
  <note>
    <para>Use Platypus Application Designer to create web application. For detailed information, refer to the Development Guide.</para>
  </note>
  <section id="sect-Administration_Guide-J2ee_Chapter-Test_Section_2">
    <title>Configuring J2EE server</title>
    <para>To run the plafrom&apos;s application in a J2EE servlet container or on the application server, perform the following actions:</para>
    <itemizedlist>
      <listitem>
        <para>Create a new directory with a standard structure for a web-application in J2EE, including the  <filename>WEB-INF/web.xml</filename>  deployment descriptor.</para>
      </listitem>
      <listitem>
        <para>Create HTML pages, which will contain the Platypus application. Configure JavaScript code, necessary for the initial startup code.</para>
      </listitem>
      <listitem>
        <para>Copy libraries, necessary for the application functioning, to the web-application <filename>WEB-INF/lib</filename> directory from the  <filename>bin</filename> sub-directory of the  platform runtime  directory.</para>
      </listitem>
      <listitem>
        <para>Copy the <filename>pwc</filename> directory of the JavaScript HTML5 client from the  <filename>bin</filename> sub-directory of the  platform runtime  directory.</para>
      </listitem>
      <listitem>
        <para>Configure the JDBC data source as a JNDI resource, specify its name, for example <literal>jdbc/main</literal>. Configure the connection pool and JNDI resource. Copy the JAR file copy of the corresponding database driver to the directory available for the class loader.</para>
      </listitem>
      <listitem>
        <para>Configure the security domain (Realm) for working with built-in storage or external authentication service. For working with built-in storage, configure the JDBC security domain for working with  <literal>MTD_USERS</literal> and <literal>MTD_GROUPS</literal> tables — see Security section.</para>
      </listitem>
      <listitem>
        <para>Configure the parameters of the web-application deployment in the  <filename>WEB-INF/web.xml</filename> file. If necessary, configure settings in the configuration files specific for this application server.</para>
      </listitem>
      <listitem>
        <para>Deploy the web-application in the J2EE container/on the application server as a WAR archive or as a directory.</para>
      </listitem>
    </itemizedlist>
  </section>
  <section id="sect-Administration_Guide-J2ee_Chapter-Test_Section_3">
    <title>Configuring the deployment descriptor</title>
    <para>To configure a web-application, edit the XML file of the  <filename>WEB-INF/web.xml</filename>  deployment descriptor. </para>
    <itemizedlist>
      <listitem>
        <para>Set the initialization parameter and specify  <parameter>url</parameter>  as its name and path to Platypus application folder as its value; the path may be absolute or relative within the web-application; when the web-application is packed into a war file, the relative path will work if the server unpacks this archive when deploying the application; if this option is not specified, the application will be loaded from the database. In the following example, an absolute path is specified</para>
        <programlisting>...
&lt;context-param&gt;
    &lt;param-name&gt;url&lt;/param-name&gt;
    &lt;param-value&gt;file:///home/Platypus/app&lt;/param-value&gt;
 &lt;/context-param&gt;
...</programlisting>
      </listitem>
      <listitem>
        <para>Set the initialization parameter and specify <parameter>default-datasource</parameter> as its name and the name of the JNDI resource of the JDBC data source as its value, for example:</para>
        <programlisting>...
&lt;context-param&gt;
    &lt;param-name&gt;default-datasource&lt;/param-name&gt;
    &lt;param-value&gt;jdbc/main&lt;/param-value&gt;
 &lt;/context-param&gt;
...</programlisting>
      </listitem>
      <listitem>
        <para>Add the session event handler:</para>
        <programlisting>...
&lt;listener&gt;       
    &lt;listener-class&gt;
com.eas.server.httpservlet.PlatypusSessionsSynchronizer
    &lt;/listener-class&gt;
&lt;/listener&gt;
...</programlisting>
      </listitem>
      <listitem>
        <para>Add a reference to the data source resource:</para>
        <programlisting>...
&lt;resource-ref&gt;
    &lt;description&gt;Main database connection&lt;/description&gt;
    &lt;res-ref-name&gt;jdbc/main&lt;/res-ref-name&gt;
    &lt;res-type&gt;javax.sql.DataSource&lt;/res-type&gt;
    &lt;res-auth&gt;Container&lt;/res-auth&gt;
&lt;/resource-ref&gt;
...</programlisting>
      </listitem>
      <listitem>
        <para>Add Platypus servlet configuration; in the <literal>multipart/location</literal>  element specify the path to the folder for storing the downloaded files:</para>
        <programlisting>...
&lt;servlet&gt;
    &lt;servlet-name&gt;PlatypusServlet&lt;/servlet-name&gt;
    &lt;servlet-class&gt;
com.eas.server.httpservlet.PlatypusHttpServlet
    &lt;/servlet-class&gt;
    &lt;load-on-startup&gt;1&lt;/load-on-startup&gt;
    &lt;multipart-config&gt;  
      &lt;location&gt;
          /home/user1/pub
      &lt;/location&gt;
      &lt;max-file-size&gt;2097152&lt;/max-file-size&gt;
      &lt;max-request-size&gt;2165824&lt;/max-request-size&gt;
      &lt;file-size-threshold&gt;1048576&lt;/file-size-threshold&gt;
    &lt;/multipart-config&gt;
  &lt;/servlet&gt;
&lt;servlet-mapping&gt;
    &lt;servlet-name&gt;PlatypusServlet&lt;/servlet-name&gt;
    &lt;url-pattern&gt;/application/*&lt;/url-pattern&gt;
&lt;/servlet-mapping&gt;
...</programlisting>
      </listitem>
      <listitem>
        <para>Configure the access and security constraints; for information on the security domain configuration, see the &quot;Security&quot; section.</para>
      </listitem>
    </itemizedlist>
    <para>After completing configuring, deploy the web-application as a folder or WAR archive in a servlet container or on the J2EE server.</para>
  </section>
  <section>
    <title>Authentication configuration on a J2EE container</title>
    <para>When an application works in a J2EE container, the platform runtime uses an authentication mechanism and roles provided by the container. To enable activation of the role access in this case, the user should pass the security constraint and get a role. To do this, configure a URL security constraint as a page containing Platypus forms, for which the access control based on roles should be provided. The following example shows the enabled security constraint for the  <filename>applicationStart.html</filename> page; to get access to this page the user should be assigned any role:</para>
    <programlisting>...
&lt;security-constraint&gt;
  &lt;web-resource-collection&gt;
      &lt;url-pattern&gt;/application-start.html&lt;/url-pattern&gt;
    &lt;/web-resource-collection&gt;
    &lt;auth-constraint&gt;
      &lt;role-name&gt;*&lt;/role-name&gt;
    &lt;/auth-constraint&gt;
&lt;/security-constraint&gt;
&lt;login-config&gt;
    &lt;auth-method&gt;FORM&lt;/auth-method&gt;
    &lt;form-login-config&gt;
      &lt;form-login-page&gt;/login.html&lt;/form-login-page&gt;
      &lt;form-error-page&gt;/login-failed.html&lt;/form-error-page&gt;
    &lt;/form-login-config&gt;
&lt;/login-config&gt;
&lt;security-role&gt;
    &lt;role-name&gt;*&lt;/role-name&gt;
&lt;/security-role&gt;
...</programlisting>
    <para>Specify the type of authentication, for example,  <literal>FORM</literal>  for authentication using HTML forms or  <literal>BASIC</literal> for basic authentication according to RFC 2617. </para>
    <para>Platypus Client supports  <literal>BASIC</literal>  authentication, so to its ensure correct operation, that particular type of authentication must be configured. </para>
    <para>Configure the repository of information about users and J2EE container for using this repository. More detailed information on these settings is provided below.</para>
    <para>When an application works in the J2EE container, you should use built-in web-server tools in addition to Platypus platform security constraints: </para>
    <itemizedlist>
      <listitem>
        <para>Restrict access to application files over HTTP. </para>
      </listitem>
      <listitem>
        <para>Restrict access to application files for Platypus resources loader, which works over URL of the following type:</para>
        <para><uri>application/resource/<replaceable>resourcePath</replaceable></uri></para>
        <para>where   <replaceable>resourcePath</replaceable> is the path to the resource in the Platypus application.</para>
      </listitem>
    </itemizedlist>
    <para>Configure access constraints in the <filename>WEB-INF/web.xml</filename>  descriptor file.</para>
    <para>The following example shows a portion of the  <filename>WEB-INF/web.xml</filename>  file. It contains constraints of access to files of the Platypus application, located in the <filename>app</filename> directory, except  <filename>public</filename> sub-directory:</para>
    <programlisting>...
&lt;security-constraint&gt;
  &lt;web-resource-collection&gt;
      &lt;!-- whitelist --&gt;
      &lt;web-resource-name /&gt;
      &lt;url-pattern&gt;/app/public/*&lt;/url-pattern&gt;
      &lt;url-pattern&gt;/application/resource/public/*
      &lt;/url-pattern&gt;
   &lt;/web-resource-collection&gt;
   &lt;!-- No auth constraint here for whitelist --&gt;
&lt;/security-constraint&gt;

&lt;security-constraint&gt;
  &lt;web-resource-collection&gt;
      &lt;!-- everything other is restricted --&gt;
      &lt;web-resource-name /&gt;
      &lt;url-pattern&gt;/app/*&lt;/url-pattern&gt;
      &lt;url-pattern&gt;/application/resource/*&lt;/url-pattern&gt;
  &lt;/web-resource-collection&gt;
  &lt;auth-constraint /&gt;
&lt;/security-constraint&gt;
...</programlisting>
  </section>
  <section>
    <title>J2EE Glassfish 3 configuration</title>
    <para>Data source setup:</para>
    <orderedlist>
      <listitem>
        <para>Copy the JAR file of the JDBC driver to the directory accessible to the class loader: <filename>glassfish/domains/mydomain/lib </filename></para>
      </listitem>
      <listitem>
        <para>Run the GlassFish administration console. To do this, start the server, for example, by using the asadmin utility. Then navigate to 
        <filename>http://hostname:4848</filename> in browser, where hostname is the address of the Glassfish application server, for example: <filename>http://localhost:4848</filename>.</para>
      </listitem>
      <listitem>
        <para>Create the JDBC connection pool: <guimenuitem>Resources -&gt; JDBC -&gt; JDBC Connection Pools -&gt; New</guimenuitem>,         <type>javax.sql.ConnectionPoolDataSource</type> resource type, and also specify the database connection parameters: <parameter>url</parameter>,  <parameter>username</parameter>, <parameter>password</parameter>.</para>
      </listitem>
      <listitem>
        <para>Check the pool settings by clicking <guibutton>Ping</guibutton>.</para>
      </listitem>
      <listitem>
        <para>Create the JNDI resource for the connection pool: <guimenuitem>Resources -&gt; JDBC Resources-&gt; New</guimenuitem>. Specify the name of the resource, for example<literal> jdbc/main</literal>, and specify the JDBC connection pool.</para>
      </listitem>
    </orderedlist>
    <para>To configure Platypus for working with internal storage of user data or external authentication service:</para>
    <itemizedlist>
      <listitem>
        <para>Configure J2EE Glassfish server for working with the security domain (Realm) in the external LDAP service.</para>
      </listitem>
      <listitem>
        <para>Configure user accounts.</para>
      </listitem>
    </itemizedlist>
    <para>To configure the Glassfish server:</para>
    <itemizedlist>
      <listitem>
        <para>Add the security domain for Glassfish — to do this, change the server configuration (Configurations -&gt; Server-config -&gt; Security -&gt; Realms -&gt;New).</para>
        <para>Specify the name of the security domain, select the class name from the list or specify your own class:  </para>
        <itemizedlist>
          <listitem>
            <para>To use the built-in Platypus storage, specify the <classname>com.sun.enterprise.security.auth.realm.jdbc.JDBCRealm</classname> class name. Configure properties, which are specific for this class: </para>
            <table>
              <title>JDBCRealm security domain properties</title>
              <tgroup cols="2">
                <tbody>
                  <row>
                    <entry>
                      <parameter>JAAS Context</parameter>
                    </entry>
                    <entry>Identifier of the login module, JDBCRealm</entry>
                  </row>
                  <row>
                    <entry>
                      <parameter>User Table</parameter>
                    </entry>
                    <entry>ame of the user tables in the database, MTD_USERS </entry>
                  </row>
                  <row>
                    <entry>
                      <parameter>User Name Column</parameter>
                    </entry>
                    <entry>Name of the column in the user table for storing user names, USR_NAME </entry>
                  </row>
                  <row>
                    <entry>
                      <parameter>Password Column</parameter>
                    </entry>
                    <entry>Name of the column in the user table for storing password hashes, USR_PASSWD </entry>
                  </row>
                  <row>
                    <entry>
                      <parameter>Group Table</parameter>
                    </entry>
                    <entry>Name of the user group table, USR_GROUPS </entry>
                  </row>
                  <row>
                    <entry>
                      <parameter>Group Name Column</parameter>
                    </entry>
                    <entry>Name of the group name column in the user group table, GROUP_NAME </entry>
                  </row>
                  <row>
                    <entry>
                      <parameter>Digest Algorithm</parameter>
                    </entry>
                    <entry>Password hashing algorithm, MD5 </entry>
                  </row>
                </tbody>
              </tgroup>
            </table>
          </listitem>
          <listitem>
            <para>To use the external LDAP service (Active Directory, OpenLDAP, etc.) specify the <classname>com.sun.enterprise.security.auth.realm.ldap.LDAPReam</classname> class name; configure properties which are specific for this class.</para>
            <table>
              <title>Basic and additional properties of the LDAPReam security domain</title>
              <tgroup cols="2">
                <tbody>
                  <row>
                    <entry>
                      <parameter>JAAS Context</parameter>
                    </entry>
                    <entry>Identifier of the login module, ldapRealm </entry>
                  </row>
                  <row>
                    <entry>
                      <parameter>Directory</parameter>
                    </entry>
                    <entry>ldap://server:389</entry>
                  </row>
                  <row>
                    <entry>
                      <parameter>Base DN</parameter>
                    </entry>
                    <entry>DC=ithit,DC=com </entry>
                  </row>
                  <row>
                    <entry>
                      <parameter>Assign Groups</parameter>
                    </entry>
                    <entry>platypus_default_role </entry>
                  </row>
                  <row>
                    <entry>
                      <parameter>search-filter</parameter>
                    </entry>
                    <entry>(&amp;(objectClass=user)(sAMAccountName=%s)) </entry>
                  </row>
                  <row>
                    <entry>
                      <parameter>search-bind-password</parameter>
                    </entry>
                    <entry>LDAP service password </entry>
                  </row>
                  <row>
                    <entry>
                      <parameter>group-search-filter</parameter>
                    </entry>
                    <entry>(&amp;(objectClass=group)(member=%d)) </entry>
                  </row>
                  <row>
                    <entry>
                      <parameter>search-bind-dn</parameter>
                    </entry>
                    <entry>ithit\user</entry>
                  </row>
                </tbody>
              </tgroup>
            </table>
            <note>
              <para>Set values of properties in accordance with the configuration of your LDAP server.  <parameter>Assign Groups</parameter>  property value, platypus_default_role group will be assigned to all users.</para>
            </note>
            <para>Configure JVM: Configurations -&gt; server-config -&gt; JVM Settings -&gt; Add JVM Option -  by adding the following option: Djava.naming.referral=follow </para>
          </listitem>
        </itemizedlist>
      </listitem>
      <listitem>
        <para>In the <filename>WEB-INF/glassfish-web.xml</filename>  file link roles to the security groups:</para>
        <programlisting>&lt;glassfish-web-app error-url=&quot;&quot;&gt;
...
  &lt;context-root&gt;/platypus&lt;/context-root&gt;
  &lt;security-role-mapping&gt;
    &lt;role-name&gt;platypus_default_role&lt;/role-name&gt;
    &lt;group-name&gt;default&lt;/group-name&gt;
  &lt;/security-role-mapping&gt;
  &lt;security-role-mapping&gt;
    &lt;role-name&gt;role1&lt;/role-name&gt;
    &lt;group-name&gt;role1&lt;/group-name&gt;
  &lt;/security-role-mapping&gt;
  &lt;security-role-mapping&gt;
    &lt;role-name&gt;role2&lt;/role-name&gt;
    &lt;group-name&gt;role2&lt;/group-name&gt;
  &lt;/security-role-mapping&gt;
..
&lt;/glassfish-web-app&gt;</programlisting>
      </listitem>
    </itemizedlist>
  </section>
  <section>
    <title>Apache Tomcat 7 configuration</title>
    <para>Data source setup:</para>
    <itemizedlist>
      <listitem>
        <para>Copy the corresponding JAR file of the JDBC driver to the directory accessible to the class loader: <filename><replaceable>CATALINA_HOME</replaceable>/lib</filename>, where <replaceable>CATALINA_HOME</replaceable> is a <application>Apache Tomcat </application>;  </para>
      </listitem>
      <listitem>
        <para>Create the JNDI resource of the JDBC data source. Edit the <filename>META-INF/context.xml</filename> file of the web application by adding the data source resource:</para>
        <programlisting>...
&lt;Resource name=&quot;jdbc/main&quot; auth=&quot;Container&quot; type=&quot;javax.sql.DataSource&quot;
       maxActive=&quot;100&quot; maxIdle=&quot;30&quot; maxWait=&quot;10000&quot;
       username=&quot;sa&quot; password=&quot;te$tPwd&quot; driverClassName=&quot;org.h2.Driver&quot;     url=&quot;jdbc:h2:tcp://localhost/~/h2db/test;schema=test&quot;/&gt;
...</programlisting>
        <para>If necessary, configure the connection pool by specifying parameters for removing and cleaning unused connections.</para>
      </listitem>
      <listitem>
        <para>Configure the security domain. Edit the <filename>META-INF/context.xml</filename> file of the web application by adding the security domain. The example below shows configuring of the security domain for working with the built-in repository of user information:</para>
        <programlisting>...
&lt;Realm  className=&quot;org.apache.catalina.realm.DataSourceRealm&quot;
   dataSourceName=&quot;jdbc/TestDB&quot;
   userTable=&quot;MTD_USERS&quot; userNameCol=&quot;USR_NAME&quot;   userCredCol=&quot;USR_PASSWD&quot;
   userRoleTable=&quot;MTD_GROUPS&quot; roleNameCol=&quot;GROUP_NAME&quot; digest=&quot;MD5&quot;/&gt;
...</programlisting>
        <para>For the DataSourceRealm security domain, specify names of tables, columns and hashing algorithm for working with <literal>MTD_USERS</literal> и <literal>MTD_GROUPS</literal> tables.</para>
        <para>If you want to use another authentication data repository, such as an external LDAP server, configure the appropriate type of security domain.</para>
      </listitem>
    </itemizedlist>
  </section>
</chapter>
